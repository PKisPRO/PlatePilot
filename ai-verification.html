<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Organic Verification - PlatePilot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="ai-config.js"></script>
    <script src="ai-config-local.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // You can add custom colors here if needed
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <!-- Navigation Bar -->
    <nav class="bg-white dark:bg-gray-900 shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <a href="index.html" class="text-2xl font-bold text-green-600 dark:text-green-400 hover:text-green-700 dark:hover:text-green-300 transition-colors">PlatePilot</a>
                <div class="hidden md:flex items-center space-x-8">
                    <a href="index.html" class="text-gray-700 dark:text-gray-300 hover:text-green-600 dark:hover:text-green-400 transition-colors">Home</a>
                    <a href="recipes.html" class="text-gray-700 dark:text-gray-300 hover:text-green-600 dark:hover:text-green-400 transition-colors">Recipes</a>
                    <a href="leaderboard.html" class="text-gray-700 dark:text-gray-300 hover:text-green-600 dark:hover:text-green-400 transition-colors">Leaderboard</a>
                    <a href="upload-recipe.html" class="text-gray-700 dark:text-gray-300 hover:text-green-600 dark:hover:text-green-400 transition-colors">Share Recipe</a>
                    <a href="games.html" class="text-gray-700 dark:text-gray-300 hover:text-green-600 dark:hover:text-green-400 transition-colors">Games</a>
                    <a href="secret-recipes.html" class="text-gray-700 dark:text-gray-300 hover:text-green-600 dark:hover:text-green-400 transition-colors">Secret Recipes</a>
                    <a href="diet-planner.html" class="text-gray-700 dark:text-gray-300 hover:text-green-600 dark:hover:text-green-400 transition-colors">Diet Planner</a>
                    <a href="ai-verification.html" class="text-green-600 dark:text-green-400 font-medium">AI Verification</a>
                    <button onclick="toggleDarkMode()" class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        <span class="dark:hidden">üåô</span>
                        <span class="hidden dark:inline">‚òÄÔ∏è</span>
                    </button>
                </div>
                <!-- Mobile Menu Button -->
                <button class="md:hidden p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" onclick="toggleMobileMenu()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
            <!-- Mobile Menu -->
            <div id="mobileMenu" class="md:hidden hidden pb-4">
                <div class="flex flex-col space-y-4">
                    <a href="index.html" class="text-gray-700 dark:text-gray-300 hover:text-green-600 dark:hover:text-green-400 transition-colors">Home</a>
                    <a href="recipes.html" class="text-gray-700 dark:text-gray-300 hover:text-green-600 dark:hover:text-green-400 transition-colors">Recipes</a>
                    <a href="leaderboard.html" class="text-gray-700 dark:text-gray-300 hover:text-green-600 dark:hover:text-green-400 transition-colors">Leaderboard</a>
                    <a href="upload-recipe.html" class="text-gray-700 dark:text-gray-300 hover:text-green-600 dark:hover:text-green-400 transition-colors">Share Recipe</a>
                    <a href="games.html" class="text-gray-700 dark:text-gray-300 hover:text-green-600 dark:hover:text-green-400 transition-colors">Games</a>
                    <a href="secret-recipes.html" class="text-gray-700 dark:text-gray-300 hover:text-green-600 dark:hover:text-green-400 transition-colors">Secret Recipes</a>
                    <a href="diet-planner.html" class="text-gray-700 dark:text-gray-300 hover:text-green-600 dark:hover:text-green-400 transition-colors">Diet Planner</a>
                    <a href="ai-verification.html" class="text-green-600 dark:text-green-400 font-medium">AI Verification</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-12">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold text-gray-800 dark:text-white mb-4">AI Organic Verification</h1>
                <p class="text-xl text-gray-600 dark:text-gray-300 mb-6">Upload images of your produce to verify organic authenticity using advanced AI analysis</p>
                <div class="flex items-center justify-center space-x-4 text-sm text-gray-500 dark:text-gray-400">
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-1 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        Instant Analysis
                    </div>
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-1 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        Expert-Level Accuracy
                    </div>
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-1 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        Privacy Protected
                    </div>
                </div>
            </div>

            <!-- Upload Section -->
            <!-- <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 mb-8">
                <div class="text-center">
                    <div id="uploadArea" class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-12 hover:border-green-500 dark:hover:border-green-400 transition-colors cursor-pointer">
                        <svg class="mx-auto h-16 w-16 text-gray-400 dark:text-gray-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Upload Produce Images</h3>
                        <p class="text-gray-500 dark:text-gray-400 mb-4">Drag and drop your images here, or click to browse</p>
                        <input type="file" id="imageInput" accept="image/*" multiple class="hidden">
                        <button onclick="document.getElementById('imageInput').click()" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors">
                            Choose Files
                        </button>
                        <p class="text-sm text-gray-400 dark:text-gray-500 mt-2">Supports JPG, PNG, WebP up to 10MB each</p>
                    </div>
                </div>
            </div> -->

            <!-- AI Assistant Chat Section -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">PlatePilot AI Assistant</h2>
                        <p class="text-gray-600 dark:text-gray-300">Chat with AI about organic produce, upload images for analysis with heatmap generation</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-sm text-gray-600 dark:text-gray-300">Live</span>
                    </div>
                </div>

                <!-- Chat Interface -->
                <div class="relative w-full bg-gray-50 dark:bg-gray-900 rounded-lg border-2 border-gray-200 dark:border-gray-700" style="height: 600px;">
                    <!-- Chat Messages Container -->
                    <div id="chatMessages" class="h-[calc(100%-80px)] overflow-y-auto p-4 space-y-4">
                        <!-- Welcome Message -->
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0 w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">
                                AI
                            </div>
                            <div class="flex-1 bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                                <p class="text-gray-800 dark:text-gray-200">üëã Hello! I'm PlatePilot AI. I can help you:</p>
                                <ul class="mt-2 text-sm text-gray-600 dark:text-gray-300 space-y-1">
                                    <li>üîç Analyze produce images for organic vs conventional classification</li>
                                    <li>üìä Generate heatmaps showing analysis regions</li>
                                    <li>üìÑ Create detailed verification reports</li>
                                    <li>üí¨ Answer questions about organic produce and nutrition</li>
                                </ul>
                                <p class="mt-3 text-sm text-gray-600 dark:text-gray-300">Upload an image or ask me a question to get started!</p>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Input Area -->
                    <div class="absolute bottom-0 left-0 right-0 p-4 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 rounded-b-lg">
                        <div class="flex items-center space-x-2">
                            <button id="chatImageUpload" class="p-2 text-gray-500 hover:text-green-600 dark:text-gray-400 dark:hover:text-green-400 transition-colors" title="Upload image">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                            <input type="file" id="chatImageInput" accept="image/*" class="hidden">
                            <input
                                type="text"
                                id="chatInput"
                                placeholder="Ask about organic produce or upload an image..."
                                class="flex-1 px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                            >
                            <button id="chatSend" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                                Send
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg border border-blue-200 dark:border-blue-800">
                    <div class="flex items-start space-x-2">
                        <svg class="w-5 h-5 text-blue-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-blue-800 dark:text-blue-200 mb-1">üí° Pro Tips:</p>
                            <ul class="text-xs text-blue-700 dark:text-blue-300 space-y-1">
                                <li>‚Ä¢ Upload clear photos of produce for best analysis results</li>
                                <li>‚Ä¢ Ask for detailed reports with heatmap visualization</li>
                                <li>‚Ä¢ Multiple angles of the same produce improve accuracy</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Analysis Results</h2>
                    <div id="resultsContainer" class="space-y-6">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </div>

            <!-- How It Works Section -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 mt-8">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">How It Works</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center">
                        <div class="bg-green-100 dark:bg-green-900 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                            <span class="text-2xl font-bold text-green-600 dark:text-green-400">1</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Upload Images</h3>
                        <p class="text-gray-600 dark:text-gray-300">Take clear photos of your produce from multiple angles, focusing on leaves, stems, and surface texture.</p>
                    </div>
                    <div class="text-center">
                        <div class="bg-green-100 dark:bg-green-900 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                            <span class="text-2xl font-bold text-green-600 dark:text-green-400">2</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">AI Analysis</h3>
                        <p class="text-gray-600 dark:text-gray-300">Our advanced AI examines visual patterns, discoloration, residue traces, and surface anomalies.</p>
                    </div>
                    <div class="text-center">
                        <div class="bg-green-100 dark:bg-green-900 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                            <span class="text-2xl font-bold text-green-600 dark:text-green-400">3</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Get Results</h3>
                        <p class="text-gray-600 dark:text-gray-300">Receive detailed analysis with confidence scores and recommendations for further verification if needed.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4">PlatePilot</h3>
                    <p class="text-gray-400">Pilot your plate. Powered by AI. Fueled by wellness.</p>
                </div>
                <div>
                    <h4 class="font-semibold mb-4">Quick Links</h4>
                    <ul class="space-y-2">
                        <li><a href="index.html" class="text-gray-400 hover:text-white transition-colors">Home</a></li>
                        <li><a href="recipes.html" class="text-gray-400 hover:text-white transition-colors">Recipes</a></li>
                        <li><a href="games.html" class="text-gray-400 hover:text-white transition-colors">Games</a></li>
                        <li><a href="secret-recipes.html" class="text-gray-400 hover:text-white transition-colors">Secret Recipes</a></li>
                        <li><a href="diet-planner.html" class="text-gray-400 hover:text-white transition-colors">Diet Planner</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold mb-4">Contact</h4>
                    <ul class="space-y-2 text-gray-400">
                        <li>Email: platepilot.11@gmail.com</li>
                        <li>Phone: +91 9251681626</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold mb-4">Follow Us</h4>
                    <div class="flex space-x-4">
                        <a href="#" class="text-gray-400 hover:text-white transition-colors">Facebook</a>
                        <a href="#" class="text-gray-400 hover:text-white transition-colors">Twitter</a>
                        <a href="#" class="text-gray-400 hover:text-white transition-colors">Instagram</a>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400">
                <p>&copy; 2024 PlatePilot. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Set base path for GitHub Pages
        const basePath = '/PlatePilot';
        
        // Update all navigation links
        document.addEventListener('DOMContentLoaded', function() {
            // Update navigation links
            document.querySelectorAll('a[href^="index.html"], a[href^="recipes.html"], a[href^="upload-recipe.html"], a[href^="games.html"], a[href^="secret-recipes.html"], a[href^="diet-planner.html"], a[href^="ai-verification.html"]').forEach(link => {
                if (!link.href.includes(basePath)) {
                    link.href = basePath + '/' + link.href;
                }
            });
            
            // Initialize dark mode
            if (localStorage.getItem('darkMode') === 'true') {
                document.documentElement.classList.add('dark');
            }
            
            // Toggle dark mode
            window.toggleDarkMode = function() {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('darkMode', 'false');
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('darkMode', 'true');
                }
            };
            
            // Mobile menu toggle
            window.toggleMobileMenu = function() {
                const mobileMenu = document.getElementById('mobileMenu');
                mobileMenu.classList.toggle('hidden');
            };

            // File upload handling (chat will be initialized at the end)
            const uploadArea = document.getElementById('uploadArea');
            const imageInput = document.getElementById('imageInput');
            const resultsSection = document.getElementById('resultsSection');
            const resultsContainer = document.getElementById('resultsContainer');

            // Drag and drop functionality (only if upload area exists)
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('border-green-500', 'bg-green-50', 'dark:bg-green-900');
                });

                uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('border-green-500', 'bg-green-50', 'dark:bg-green-900');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('border-green-500', 'bg-green-50', 'dark:bg-green-900');
                    const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
                    if (files.length > 0) {
                        processFiles(files);
                    }
                });
            }

            if (imageInput) {
                imageInput.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    if (files.length > 0) {
                        processFiles(files);
                    }
                });
            }

            async function processFiles(files) {
                resultsContainer.innerHTML = '';
                resultsSection.classList.remove('hidden');
                
                for (const file of files) {
                    await analyzeImage(file);
                }
            }

            async function analyzeImage(file) {
                // Create result card
                const resultCard = document.createElement('div');
                resultCard.className = 'border rounded-lg p-6 bg-gray-50 dark:bg-gray-700';
                resultCard.innerHTML = `
                    <div class="flex items-start space-x-4">
                        <img src="${URL.createObjectURL(file)}" alt="Uploaded image" class="w-24 h-24 object-cover rounded-lg">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">${file.name}</h3>
                            <div class="flex items-center space-x-2 mb-2">
                                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-green-500"></div>
                                <span class="text-sm text-gray-600 dark:text-gray-300">Analyzing...</span>
                            </div>
                            <div id="result-${file.name}" class="text-sm text-gray-600 dark:text-gray-300">
                                <!-- Results will be populated here -->
                            </div>
                        </div>
                    </div>
                `;
                resultsContainer.appendChild(resultCard);

                try {
                    // Convert image to base64
                    const base64 = await fileToBase64(file);
                    
                    // Call your custom GPT API
                    const result = await callOrganicVerificationAPI(base64, file.name);
                    
                    // Update the result card
                    const resultDiv = document.getElementById(`result-${file.name}`);
                    resultDiv.innerHTML = `
                        <div class="space-y-3">
                            <!-- Classification Badge -->
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs font-semibold text-gray-600 dark:text-gray-400">Classification:</span>
                                    <span class="px-3 py-1 rounded-full text-xs font-bold ${result.classification === 'organic' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">
                                        ${result.classification?.toUpperCase() || 'UNKNOWN'}
                                    </span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs font-semibold text-gray-600 dark:text-gray-400">Confidence:</span>
                                    <span class="text-lg font-bold ${result.confidence >= 70 ? 'text-green-600' : result.confidence >= 40 ? 'text-yellow-600' : 'text-red-600'}">
                                        ${result.confidence}%
                                    </span>
                                </div>
                            </div>

                            <!-- Progress Bar -->
                            <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-3">
                                <div class="h-3 rounded-full transition-all ${result.confidence >= 70 ? 'bg-green-500' : result.confidence >= 40 ? 'bg-yellow-500' : 'bg-red-500'}"
                                     style="width: ${result.confidence}%"></div>
                            </div>

                            <!-- Professional Analysis -->
                            <div class="text-sm bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border border-blue-200 dark:border-blue-800">
                                <strong class="text-blue-800 dark:text-blue-300">Professional Analysis:</strong>
                                <p class="mt-1 text-gray-700 dark:text-gray-300">${result.analysis}</p>
                            </div>

                            <!-- Recommendation -->
                            <div class="text-sm">
                                <span class="font-semibold">Recommendation:</span>
                                <span class="ml-2 px-2 py-1 rounded text-xs font-medium ${result.recommendation === 'pass' ? 'bg-green-100 text-green-700' : result.recommendation === 'fail' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">
                                    ${result.recommendation.toUpperCase()}
                                </span>
                            </div>
                            ${result.keyFindings && result.keyFindings.length > 0 ? 
                                `<div class="text-sm">
                                    <strong>Key Findings:</strong>
                                    <ul class="list-disc list-inside mt-1">
                                        ${result.keyFindings.map(finding => `<li>${finding}</li>`).join('')}
                                    </ul>
                                </div>` : ''}
                            ${result.heatmapData && Object.keys(result.heatmapData).length > 0 ?
                                `<div class="text-sm mt-3 bg-purple-50 dark:bg-purple-900/20 p-3 rounded-lg border border-purple-200 dark:border-purple-800">
                                    <strong class="text-purple-800 dark:text-purple-300">üìä Analysis Heatmap (Indicator Scores):</strong>
                                    <div class="grid grid-cols-1 gap-3 mt-3">
                                        ${Object.entries(result.heatmapData).map(([key, value]) => `
                                            <div class="space-y-1">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-xs font-semibold capitalize text-gray-700 dark:text-gray-300">${key.replace(/_/g, ' ')}:</span>
                                                    <span class="text-xs font-bold ${value > 70 ? 'text-red-600' : value > 40 ? 'text-yellow-600' : 'text-green-600'}">${value}%</span>
                                                </div>
                                                <div class="w-full h-3 bg-gray-200 dark:bg-gray-600 rounded-full overflow-hidden">
                                                    <div class="h-3 rounded-full transition-all ${value > 70 ? 'bg-gradient-to-r from-red-400 to-red-600' : value > 40 ? 'bg-gradient-to-r from-yellow-400 to-yellow-600' : 'bg-gradient-to-r from-green-400 to-green-600'}"
                                                         style="width: ${value}%"></div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <p class="text-xs text-gray-600 dark:text-gray-400 mt-2 italic">
                                        Lower scores (green) indicate organic characteristics. Higher scores (red) suggest synthetic indicators.
                                    </p>
                                </div>` : ''}
                            ${result.flagged ? '<div class="text-sm text-red-600 font-medium">‚ö†Ô∏è Flagged for expert review</div>' : ''}
                            <div class="mt-3 flex space-x-2">
                                <button onclick="generateReport('${file.name}', ${JSON.stringify(result).replace(/"/g, '&quot;')})" 
                                        class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600">
                                    üìÑ Generate Report
                                </button>
                                ${result.heatmapData && Object.keys(result.heatmapData).length > 0 ? 
                                `<button onclick="downloadHeatmap('${file.name}', ${JSON.stringify(result.heatmapData).replace(/"/g, '&quot;')})" 
                                        class="bg-purple-500 text-white px-3 py-1 rounded text-xs hover:bg-purple-600">
                                    üó∫Ô∏è Download Heatmap
                                </button>` : ''}
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Analysis failed:', error);
                    const resultDiv = document.getElementById(`result-${file.name}`);
                    resultDiv.innerHTML = `
                        <div class="text-sm text-red-600">
                            Analysis failed. Please try again or contact support.
                        </div>
                    `;
                }
            }

            function fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }

            async function callOrganicVerificationAPI(base64Image, filename) {
                try {
                    // Wait for AI_CONFIG to be loaded
                    let attempts = 0;
                    while (typeof AI_CONFIG === 'undefined' && attempts < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }

                    if (typeof AI_CONFIG === 'undefined') {
                        throw new Error('AI_CONFIG not loaded');
                    }

                    console.log('Making API call with model:', AI_CONFIG.MODEL_NAME);

                    // Extract base64 data and mime type
                    const matches = base64Image.match(/^data:([A-Za-z-+\/]+);base64,(.+)$/);
                    if (!matches || matches.length !== 3) {
                        throw new Error('Invalid base64 image format');
                    }

                    const mimeType = matches[1];
                    const base64Data = matches[2];

                    // Use OpenAI API if configured, otherwise fall back to Gemini
                    const isOpenAI = AI_CONFIG.API_TYPE === 'openai' || AI_CONFIG.API_BASE_URL.includes('openai.com');
                    
                    let apiUrl, requestBody, headers;
                    
                    if (isOpenAI) {
                        // OpenAI API format
                        apiUrl = `${AI_CONFIG.API_BASE_URL}/chat/completions`;
                        headers = {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${AI_CONFIG.API_KEY}`
                        };
                        requestBody = {
                            model: AI_CONFIG.MODEL_NAME || 'gpt-4o',
                            messages: [
                                {
                                    role: 'user',
                                    content: [
                                        {
                                            type: 'text',
                                            text: `${AI_CONFIG.SYSTEM_PROMPT}\n\nPlease analyze this image (${filename}) for organic authenticity. Provide your analysis in the specified JSON format with heatmap data.`
                                        },
                                        {
                                            type: 'image_url',
                                            image_url: {
                                                url: `data:${mimeType};base64,${base64Data}`
                                            }
                                        }
                                    ]
                                }
                            ],
                            max_tokens: 1000,
                            temperature: 0.1
                        };
                    } else {
                        // Gemini API format (fallback)
                        apiUrl = `${AI_CONFIG.API_BASE_URL}/models/${AI_CONFIG.MODEL_NAME}:generateContent?key=${AI_CONFIG.API_KEY}`;
                        headers = {
                            'Content-Type': 'application/json'
                        };
                        requestBody = {
                            contents: [
                                {
                                    parts: [
                                        {
                                            text: `${AI_CONFIG.SYSTEM_PROMPT}\n\nPlease analyze this image (${filename}) for organic authenticity. Provide your analysis in the specified JSON format with heatmap data.`
                                        },
                                        {
                                            inline_data: {
                                                mime_type: mimeType,
                                                data: base64Data
                                            }
                                        }
                                    ]
                                }
                            ],
                            generationConfig: {
                                temperature: 0.1,
                                maxOutputTokens: 1000,
                            }
                        };
                    }

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API request failed: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                    }

                    const data = await response.json();
                    // Handle both OpenAI and Gemini response formats
                    let content;
                    if (isOpenAI) {
                        content = data.choices[0].message.content;
                    } else {
                        content = data.candidates[0].content.parts[0].text;
                    }

                    console.log('API Response:', content);

                    // Try to parse JSON response (handle markdown code blocks from Gemini)
                    try {
                        let jsonContent = content;

                        // Remove markdown code blocks if present
                        if (content.includes('```json')) {
                            jsonContent = content.match(/```json\s*([\s\S]*?)\s*```/)?.[1] || content;
                        } else if (content.includes('```')) {
                            jsonContent = content.match(/```\s*([\s\S]*?)\s*```/)?.[1] || content;
                        }

                        const result = JSON.parse(jsonContent.trim());
                        return {
                            confidence: result.confidence || 50,
                            analysis: result.analysis || 'Analysis completed',
                            recommendation: result.recommendation || 'review',
                            keyFindings: result.key_findings || [],
                            flagged: result.flagged || false,
                            heatmapData: result.heatmap_data || {}
                        };
                    } catch (parseError) {
                        console.error('Failed to parse JSON response:', parseError);
                        // Fallback parsing if JSON format isn't followed
                        return parseTextResponse(content);
                    }
                    
                } catch (error) {
                    console.error('API call failed:', error);
                    // Fallback response for demo purposes
                    return {
                        confidence: Math.floor(Math.random() * 100),
                        analysis: 'Unable to connect to verification service. Please try again later.',
                        recommendation: 'Manual review recommended',
                        keyFindings: ['Service unavailable'],
                        flagged: true,
                        heatmapData: {}
                    };
                }
            }

            function parseTextResponse(content) {
                const confidenceMatch = content.match(/(\d+)%/);
                const confidence = confidenceMatch ? parseInt(confidenceMatch[1]) : 50;
                
                const analysis = content.split('Analysis:')[1]?.split('Recommendation:')[0]?.trim() || 
                               content.split('analysis:')[1]?.split('recommendation:')[0]?.trim() || 
                               'Analysis completed';
                
                const recommendation = content.includes('pass') ? 'pass' :
                                    content.includes('fail') ? 'fail' :
                                    'review';
                
                const flagged = confidence < 70;
                
                return {
                    confidence,
                    analysis,
                    recommendation,
                    keyFindings: [],
                    flagged,
                    heatmapData: {}
                };
            }

            // Generate professional verification report
            function generateReport(filename, result) {
                // Parse the result string back to object if needed
                const resultObj = typeof result === 'string' ? JSON.parse(result.replace(/&quot;/g, '"')) : result;

                const timestamp = new Date();
                const reportId = `PLT-${timestamp.getTime()}`;

                const reportData = {
                    reportId: reportId,
                    filename: filename,
                    timestamp: timestamp.toISOString(),
                    verification: {
                        classification: resultObj.classification || 'unknown',
                        confidence: resultObj.confidence,
                        recommendation: resultObj.recommendation,
                        flagged: resultObj.flagged,
                        analysis: resultObj.analysis,
                        keyFindings: resultObj.keyFindings,
                        heatmapData: resultObj.heatmapData,
                        professionalNotes: resultObj.professionalNotes || ''
                    },
                    metadata: {
                        analyzer: 'PlatePilot AI Organic Verification System',
                        version: '2.0',
                        model: 'Google Gemini 1.5 Flash',
                        certifiedBy: 'AI Visual Analysis Engine'
                    }
                };

                const reportContent = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            ORGANIC PRODUCE VERIFICATION REPORT
                PlatePilot AI Analysis System
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

REPORT ID: ${reportId}
ANALYSIS DATE: ${timestamp.toLocaleString('en-US', {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
    hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short'
})}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SAMPLE INFORMATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
File Name: ${filename}
Analysis Type: Visual Inspection - AI-Powered
Certification Level: Preliminary Assessment

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
VERIFICATION RESULTS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Classification: ${(resultObj.classification || 'UNKNOWN').toUpperCase()}
Confidence Level: ${resultObj.confidence}% ${resultObj.confidence >= 70 ? '‚úì HIGH' : resultObj.confidence >= 40 ? '‚ö† MODERATE' : '‚úó LOW'}
Recommendation: ${resultObj.recommendation.toUpperCase()}
Status: ${resultObj.flagged ? '‚ö†Ô∏è FLAGGED FOR EXPERT REVIEW' : '‚úì CLEARED'}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
PROFESSIONAL ANALYSIS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${resultObj.analysis}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
KEY FINDINGS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${resultObj.keyFindings && resultObj.keyFindings.length > 0 ?
    resultObj.keyFindings.map((finding, i) => `${i + 1}. ${finding}`).join('\n') :
    'No specific findings reported'}


‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
ANALYSIS HEATMAP (Indicator Scoring)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${resultObj.heatmapData && Object.keys(resultObj.heatmapData).length > 0 ?
    Object.entries(resultObj.heatmapData).map(([key, value]) => {
        const bar = '‚ñà'.repeat(Math.floor(value / 5)) + '‚ñë'.repeat(20 - Math.floor(value / 5));
        const status = value > 70 ? '‚ö† HIGH' : value > 40 ? '‚óã MODERATE' : '‚úì LOW';
        return `${key.replace(/_/g, ' ').toUpperCase()}:\n  ${bar} ${value}% ${status}`;
    }).join('\n\n') :
    'No heatmap data available'}

Note: Lower scores indicate organic characteristics (good).
      Higher scores suggest synthetic/conventional indicators (concern).

${resultObj.professionalNotes ? `
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
PROFESSIONAL NOTES
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${resultObj.professionalNotes}
` : ''}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
TECHNICAL DETAILS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Analysis Engine: Google Gemini 1.5 Flash (AI Vision Model)
System Version: PlatePilot V2.0
Analysis Method: Multi-factor Visual Assessment
Confidence Thresholds:
  ‚Ä¢ PASS: ‚â•70% confidence
  ‚Ä¢ REVIEW: 40-69% confidence
  ‚Ä¢ FAIL: <40% confidence

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
DISCLAIMER & CERTIFICATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
This report represents a preliminary AI-powered visual analysis
and should be used as a screening tool only. For official organic
certification, please consult with licensed certifying agencies.

The analysis is based on visual indicators only and does not
constitute laboratory testing or chemical analysis.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
              END OF VERIFICATION REPORT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Generated by: PlatePilot AI Organic Verification System
Contact: platepilot.11@gmail.com
Website: https://platepilo—Ç.com
Report Date: ${timestamp.toISOString()}
                `;

                // Create and download the report
                const blob = new Blob([reportContent], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `organic_verification_report_${filename.replace(/\.[^/.]+$/, '')}_${new Date().toISOString().split('T')[0]}.md`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Also save JSON data
                const jsonBlob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
                const jsonUrl = URL.createObjectURL(jsonBlob);
                const jsonA = document.createElement('a');
                jsonA.href = jsonUrl;
                jsonA.download = `organic_verification_data_${filename.replace(/\.[^/.]+$/, '')}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(jsonA);
                jsonA.click();
                document.body.removeChild(jsonA);
                URL.revokeObjectURL(jsonUrl);
            }

            // ==================== CHAT INTERFACE FUNCTIONS ====================

            // Chat functionality - will be initialized after DOM is loaded
            let chatMessages, chatInput, chatSend, chatImageUpload, chatImageInput;

            // Add user message to chat
            function addUserMessage(text, imageUrl = null) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex items-start space-x-3 justify-end';
                messageDiv.innerHTML = `
                    <div class="flex-1 bg-green-500 text-white rounded-lg p-4 shadow max-w-md ml-auto">
                        ${imageUrl ? `<img src="${imageUrl}" class="w-full rounded mb-2 max-h-48 object-cover">` : ''}
                        <p class="text-sm">${text}</p>
                    </div>
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">
                        U
                    </div>
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Add AI message to chat
            function addAIMessage(content, isHtml = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex items-start space-x-3';
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">
                        AI
                    </div>
                    <div class="flex-1 bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                        ${isHtml ? content : `<p class="text-gray-800 dark:text-gray-200 text-sm whitespace-pre-wrap">${content}</p>`}
                    </div>
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Add loading message
            function addLoadingMessage() {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex items-start space-x-3 loading-message';
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">
                        AI
                    </div>
                    <div class="flex-1 bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                        <div class="flex items-center space-x-2">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-green-500"></div>
                            <span class="text-sm text-gray-600 dark:text-gray-300">Analyzing...</span>
                        </div>
                    </div>
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                return messageDiv;
            }

            // Remove loading message
            function removeLoadingMessage() {
                const loadingMsg = chatMessages.querySelector('.loading-message');
                if (loadingMsg) loadingMsg.remove();
            }

            // Rate limiting variables
            let lastRequestTime = 0;
            const MIN_REQUEST_INTERVAL = 2000; // 2 seconds between requests

            // Call Gemini API for chat
            async function sendChatMessage(message, imageBase64 = null) {
                try {
                    // Rate limiting - wait if requests are too frequent
                    const now = Date.now();
                    const timeSinceLastRequest = now - lastRequestTime;
                    if (timeSinceLastRequest < MIN_REQUEST_INTERVAL) {
                        await new Promise(resolve => setTimeout(resolve, MIN_REQUEST_INTERVAL - timeSinceLastRequest));
                    }
                    lastRequestTime = Date.now();

                    // Wait for AI_CONFIG to be loaded
                    let attempts = 0;
                    while (typeof AI_CONFIG === 'undefined' && attempts < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }

                    if (typeof AI_CONFIG === 'undefined') {
                        throw new Error('AI_CONFIG not loaded');
                    }

                    const systemPrompt = `You are PlatePilot AI, a certified organic agriculture inspector specializing in visual produce analysis.

FOR IMAGE ANALYSIS - Use this exact JSON format (no markdown):
{
  "confidence": 85,
  "classification": "organic",
  "analysis": "Professional 2-3 sentence analysis with specific observations",
  "recommendation": "pass",
  "key_findings": ["Specific finding 1", "Specific finding 2", "Specific finding 3"],
  "flagged": false,
  "heatmap_data": {
    "discoloration_score": 15,
    "residue_score": 10,
    "texture_score": 20,
    "color_uniformity_score": 25,
    "natural_damage_score": 30
  },
  "professional_notes": "Technical notes"
}

SCORING: Lower = organic (good), Higher = synthetic (concern)
- confidence: 0-100% certainty of classification
- heatmap scores: 0=natural/good, 100=synthetic/concerning

FOR TEXT QUESTIONS:
- Answer conversationally and informatively
- Focus on organic farming, nutrition, and food safety
- Be helpful and professional

KEY: For images, ALWAYS return pure JSON (no markdown blocks).`;

                    // Use OpenAI API if configured, otherwise fall back to Gemini
                    const isOpenAI = AI_CONFIG.API_TYPE === 'openai' || AI_CONFIG.API_BASE_URL.includes('openai.com');
                    
                    let apiUrl, requestBody, headers;
                    
                    if (isOpenAI) {
                        // OpenAI API format
                        apiUrl = `${AI_CONFIG.API_BASE_URL}/chat/completions`;
                        headers = {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${AI_CONFIG.API_KEY}`
                        };
                        
                        const contentArray = [
                            {
                                type: 'text',
                                text: `${systemPrompt}\n\n${message || 'Analyze this produce image for organic vs conventional classification. Provide confidence score, analysis, key findings, and heatmap data in JSON format.'}`
                            }
                        ];
                        
                        if (imageBase64) {
                            // Extract base64 data and mime type
                            const matches = imageBase64.match(/^data:([A-Za-z-+\/]+);base64,(.+)$/);
                            if (!matches || matches.length !== 3) {
                                throw new Error('Invalid base64 image format');
                            }
                            const mimeType = matches[1];
                            const base64Data = matches[2];
                            
                            contentArray.push({
                                type: 'image_url',
                                image_url: {
                                    url: `data:${mimeType};base64,${base64Data}`
                                }
                            });
                        }
                        
                        requestBody = {
                            model: AI_CONFIG.MODEL_NAME || 'gpt-4o',
                            messages: [
                                {
                                    role: 'user',
                                    content: contentArray
                                }
                            ],
                            max_tokens: 1500,
                            temperature: 0.3
                        };
                    } else {
                        // Gemini API format (fallback)
                        apiUrl = `${AI_CONFIG.API_BASE_URL}/models/${AI_CONFIG.MODEL_NAME}:generateContent?key=${AI_CONFIG.API_KEY}`;
                        headers = {
                            'Content-Type': 'application/json'
                        };
                        
                        const parts = [];
                        if (imageBase64) {
                            // Extract base64 data and mime type
                            const matches = imageBase64.match(/^data:([A-Za-z-+\/]+);base64,(.+)$/);
                            if (!matches || matches.length !== 3) {
                                throw new Error('Invalid base64 image format');
                            }
                            const mimeType = matches[1];
                            const base64Data = matches[2];

                            parts.push({
                                text: `${systemPrompt}\n\n${message || 'Analyze this produce image for organic vs conventional classification. Provide confidence score, analysis, key findings, and heatmap data in JSON format.'}`
                            });

                            parts.push({
                                inline_data: {
                                    mime_type: mimeType,
                                    data: base64Data
                                }
                            });
                        } else {
                            parts.push({
                                text: `${systemPrompt}\n\n${message}`
                            });
                        }
                        
                        requestBody = {
                            contents: [
                                {
                                    parts: parts
                                }
                            ],
                            generationConfig: {
                                temperature: 0.3,
                                maxOutputTokens: 1500,
                            }
                        };
                    }

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API request failed: ${response.status} - ${JSON.stringify(errorData)}`);
                    }

                    const data = await response.json();
                    // Handle both OpenAI and Gemini response formats
                    let content;
                    if (isOpenAI) {
                        content = data.choices[0].message.content;
                    } else {
                        content = data.candidates[0].content.parts[0].text;
                    }

                    return content;

                } catch (error) {
                    console.error('Chat API call failed:', error);

                    // Check if it's a rate limit error
                    if (error.message && error.message.includes('429')) {
                        return 'RATE_LIMIT_ERROR: I apologize, but we\'ve hit the API rate limit. Please wait a moment and try again. If this persists, check your Google Cloud API quota.';
                    }

                    return null;
                }
            }

            // Format analysis result as HTML
            function formatAnalysisResult(result, imageSrc) {
                return `
                    <div class="space-y-4">
                        ${imageSrc ? `<img src="${imageSrc}" class="w-full rounded-lg max-h-48 object-cover mb-3">` : ''}
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="text-lg font-bold text-gray-800 dark:text-gray-200">Classification:</span>
                                <span class="ml-2 text-lg font-bold ${result.classification === 'organic' ? 'text-green-600' : 'text-orange-600'}">${result.classification?.toUpperCase()}</span>
                            </div>
                            <div class="text-right">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Confidence:</span>
                                <span class="ml-1 text-lg font-bold ${result.confidence >= 70 ? 'text-green-600' : result.confidence >= 40 ? 'text-yellow-600' : 'text-red-600'}">${result.confidence}%</span>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                            <div class="h-2 rounded-full ${result.confidence >= 70 ? 'bg-green-500' : result.confidence >= 40 ? 'bg-yellow-500' : 'bg-red-500'}"
                                 style="width: ${result.confidence}%"></div>
                        </div>
                        <div class="text-sm">
                            <strong class="text-gray-800 dark:text-gray-200">Analysis:</strong>
                            <p class="mt-1 text-gray-600 dark:text-gray-300">${result.analysis}</p>
                        </div>
                        ${result.key_findings && result.key_findings.length > 0 ? `
                            <div class="text-sm">
                                <strong class="text-gray-800 dark:text-gray-200">Key Findings:</strong>
                                <ul class="list-disc list-inside mt-1 text-gray-600 dark:text-gray-300 space-y-1">
                                    ${result.key_findings.map(finding => `<li>${finding}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${result.heatmap_data && Object.keys(result.heatmap_data).length > 0 ? `
                            <div class="text-sm">
                                <strong class="text-gray-800 dark:text-gray-200">Analysis Heatmap:</strong>
                                <div class="grid grid-cols-1 gap-2 mt-2">
                                    ${Object.entries(result.heatmap_data).map(([key, value]) => `
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs capitalize text-gray-600 dark:text-gray-300">${key.replace(/_/g, ' ')}:</span>
                                            <div class="flex items-center">
                                                <div class="w-24 h-2 bg-gray-200 dark:bg-gray-600 rounded-full mr-2">
                                                    <div class="h-2 rounded-full ${value > 70 ? 'bg-red-500' : value > 40 ? 'bg-yellow-500' : 'bg-green-500'}"
                                                         style="width: ${value}%"></div>
                                                </div>
                                                <span class="text-xs font-medium text-gray-600 dark:text-gray-300">${value}%</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        <div class="flex space-x-2 pt-2">
                            <button onclick="generateChatReport(${JSON.stringify(result).replace(/"/g, '&quot;')})"
                                    class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600 transition-colors">
                                üìÑ Download Report
                            </button>
                            ${result.heatmap_data ? `
                                <button onclick="downloadChatHeatmap(${JSON.stringify(result.heatmap_data).replace(/"/g, '&quot;')})"
                                        class="bg-purple-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-600 transition-colors">
                                    üó∫Ô∏è Download Heatmap
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Handle send message
            async function handleSendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;

                addUserMessage(message);
                chatInput.value = '';

                const loadingMsg = addLoadingMessage();
                const response = await sendChatMessage(message);
                removeLoadingMessage();

                if (response) {
                    addAIMessage(response);
                } else {
                    addAIMessage('Sorry, I encountered an error. Please try again.');
                }
            }

            // Handle image upload
            async function handleImageUpload(file) {
                const imageUrl = URL.createObjectURL(file);
                addUserMessage('Analyze this produce image', imageUrl);

                const loadingMsg = addLoadingMessage();
                const base64 = await fileToBase64(file);
                const response = await sendChatMessage('Analyze this produce for organic verification', base64);
                removeLoadingMessage();

                if (response) {
                    try {
                        // Try to parse as JSON (handle markdown code blocks from Gemini)
                        let jsonContent = response;

                        // Remove markdown code blocks if present
                        if (response.includes('```json')) {
                            jsonContent = response.match(/```json\s*([\s\S]*?)\s*```/)?.[1] || response;
                        } else if (response.includes('```')) {
                            jsonContent = response.match(/```\s*([\s\S]*?)\s*```/)?.[1] || response;
                        }

                        const result = JSON.parse(jsonContent.trim());
                        const formattedHtml = formatAnalysisResult(result, imageUrl);
                        addAIMessage(formattedHtml, true);
                    } catch (e) {
                        // If not JSON, show as text
                        console.log('Could not parse JSON, showing as text:', e);
                        addAIMessage(response);
                    }
                } else {
                    addAIMessage('Sorry, I encountered an error analyzing the image. Please try again.');
                }
            }

            // Initialize chat elements and set up event listeners
            function initializeChatElements() {
                chatMessages = document.getElementById('chatMessages');
                chatInput = document.getElementById('chatInput');
                chatSend = document.getElementById('chatSend');
                chatImageUpload = document.getElementById('chatImageUpload');
                chatImageInput = document.getElementById('chatImageInput');

                console.log('Initializing chat elements:', {
                    chatMessages: !!chatMessages,
                    chatInput: !!chatInput,
                    chatSend: !!chatSend,
                    chatImageUpload: !!chatImageUpload,
                    chatImageInput: !!chatImageInput
                });

                // Set up event listeners
                if (chatSend) {
                    chatSend.addEventListener('click', handleSendMessage);
                    console.log('Send button listener attached');
                }
                if (chatInput) {
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') handleSendMessage();
                    });
                    console.log('Input keypress listener attached');
                }
                if (chatImageUpload) {
                    chatImageUpload.addEventListener('click', () => {
                        console.log('Image upload button clicked');
                        if (chatImageInput) {
                            chatImageInput.click();
                        }
                    });
                    console.log('Image upload button listener attached');
                }
                if (chatImageInput) {
                    chatImageInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            console.log('File selected:', file.name);
                            handleImageUpload(file);
                        }
                    });
                    console.log('Image input change listener attached');
                }
            }

            // Generate report from chat
            window.generateChatReport = function(result) {
                const resultObj = typeof result === 'string' ? JSON.parse(result.replace(/&quot;/g, '"')) : result;
                generateReport('produce_analysis.jpg', resultObj);
            };

            // Download heatmap from chat
            window.downloadChatHeatmap = function(heatmapData) {
                const data = typeof heatmapData === 'string' ? JSON.parse(heatmapData.replace(/&quot;/g, '"')) : heatmapData;
                downloadHeatmap('produce_analysis.jpg', data);
            };

            // ==================== END CHAT INTERFACE ====================

            // Generate and download heatmap visualization
            function downloadHeatmap(filename, heatmapData) {
                // Parse the heatmap data string back to object if needed
                const data = typeof heatmapData === 'string' ? JSON.parse(heatmapData.replace(/&quot;/g, '"')) : heatmapData;
                
                if (!data || Object.keys(data).length === 0) {
                    alert('No heatmap data available for this analysis.');
                    return;
                }

                // Create SVG heatmap
                const svgWidth = 400;
                const svgHeight = 300;
                const margin = 40;
                const chartWidth = svgWidth - 2 * margin;
                const chartHeight = svgHeight - 2 * margin;

                const svg = `
<svg width="${svgWidth}" height="${svgHeight}" xmlns="http://www.w3.org/2000/svg">
    <defs>
        <linearGradient id="heatmapGradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#10B981;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#F59E0B;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#EF4444;stop-opacity:1" />
        </linearGradient>
    </defs>
    
    <!-- Background -->
    <rect width="${svgWidth}" height="${svgHeight}" fill="#F9FAFB"/>
    
    <!-- Title -->
    <text x="${svgWidth/2}" y="25" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#374151">
        Organic Verification Heatmap
    </text>
    
    <!-- Subtitle -->
    <text x="${svgWidth/2}" y="45" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="#6B7280">
        ${filename} - ${new Date().toLocaleDateString()}
    </text>
    
    <!-- Heatmap bars -->
    ${Object.entries(data).map(([key, value], index) => {
        const barHeight = 30;
        const barY = margin + 60 + index * (barHeight + 10);
        const barWidth = (value / 100) * chartWidth;
        const color = value > 70 ? '#EF4444' : value > 40 ? '#F59E0B' : '#10B981';
        
        return `
            <!-- Bar background -->
            <rect x="${margin}" y="${barY}" width="${chartWidth}" height="${barHeight}" fill="#E5E7EB" rx="4"/>
            
            <!-- Bar fill -->
            <rect x="${margin}" y="${barY}" width="${barWidth}" height="${barHeight}" fill="${color}" rx="4"/>
            
            <!-- Label -->
            <text x="${margin - 10}" y="${barY + barHeight/2 + 4}" text-anchor="end" font-family="Arial, sans-serif" font-size="12" fill="#374151">
                ${key.replace('_', ' ').toUpperCase()}
            </text>
            
            <!-- Value -->
            <text x="${margin + barWidth + 10}" y="${barY + barHeight/2 + 4}" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#374151">
                ${value}%
            </text>
        `;
    }).join('')}
    
    <!-- Legend -->
    <g transform="translate(${margin}, ${svgHeight - 30})">
        <text x="0" y="0" font-family="Arial, sans-serif" font-size="10" fill="#6B7280">Legend:</text>
        <rect x="50" y="-8" width="15" height="15" fill="#10B981" rx="2"/>
        <text x="70" y="0" font-family="Arial, sans-serif" font-size="10" fill="#6B7280">Good (0-40%)</text>
        <rect x="130" y="-8" width="15" height="15" fill="#F59E0B" rx="2"/>
        <text x="150" y="0" font-family="Arial, sans-serif" font-size="10" fill="#6B7280">Moderate (40-70%)</text>
        <rect x="230" y="-8" width="15" height="15" fill="#EF4444" rx="2"/>
        <text x="250" y="0" font-family="Arial, sans-serif" font-size="10" fill="#6B7280">Concerning (70-100%)</text>
    </g>
    
    <!-- Footer -->
    <text x="${svgWidth/2}" y="${svgHeight - 5}" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#9CA3AF">
        Generated by PlatePilot AI Organic Verification System
    </text>
</svg>`;

                // Create and download the SVG
                const blob = new Blob([svg], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `organic_heatmap_${filename.replace(/\.[^/.]+$/, '')}_${new Date().toISOString().split('T')[0]}.svg`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // ==================== INITIALIZE CHAT AT THE END ====================
            // Now that all functions are defined, initialize the chat interface
            console.log('About to initialize chat elements...');
            initializeChatElements();
            console.log('Chat elements initialized!');
        });
    </script>
</body>
</html>
